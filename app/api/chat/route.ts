import { NextResponse } from 'next/server';
import OpenAI from 'openai';

// Typhoon AI Client (OpenAI-compatible)
const typhoon = new OpenAI({
  apiKey: process.env.TYPHOON_API_KEY || '',
  baseURL: 'https://api.opentyphoon.ai/v1',
});

export async function POST(req: Request) {
  try {
    const { message, history } = await req.json();

    // ‡πÅ‡∏õ‡∏•‡∏á history format
    const messages: OpenAI.ChatCompletionMessageParam[] = [
      {
        role: 'system',
        content: `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏µ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡∏ß‡∏±‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∏‡∏¢‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏à‡∏≤‡∏Å Mind Buddy üíñ

üéØ ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å:
- ‡∏û‡∏π‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó ‡πÉ‡∏ä‡πâ "‡πÄ‡∏£‡∏≤/‡πÅ‡∏Å" ‡∏´‡∏£‡∏∑‡∏≠ "‡πÄ‡∏£‡∏≤/‡πÄ‡∏ò‡∏≠"
- ‡∏†‡∏≤‡∏©‡∏≤‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á (‡πÇ‡∏´, ‡∏≠‡∏∑‡∏≠, ‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏Å, ‡πÄ‡∏´‡πâ‡∏≠‡∏≠‡∏≠, 555)
- ‡πÑ‡∏°‡πà‡∏™‡∏±‡πà‡∏á‡∏™‡∏≠‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
- ‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏à ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ

üìù ‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:
- ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ 1-3 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏ä‡∏ó‡∏à‡∏£‡∏¥‡∏á
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ bullet points ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏¥‡∏™‡∏ï‡πå
- ‡πÉ‡∏ä‡πâ emoji ‡∏ô‡πâ‡∏≠‡∏¢‡πÜ ‡πÅ‡∏Ñ‡πà 1-2 ‡∏ï‡∏±‡∏ß

üåü ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á - Mind Buddy ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£:
- ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏£‡∏π‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å
- Buddy Review: ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏à‡∏≤‡∏Å‡∏û‡∏µ‡πà‡πÜ‡πÉ‡∏ô‡∏°‡∏´‡∏≤‡∏•‡∏±‡∏¢
- Learn with Buddy: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
- Mind Care: ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø
- Buddy Connect: ‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç
- ‡∏™‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï 1323`
      }
    ];

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÑ‡∏°‡πà‡∏™‡πà‡∏á history ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)
    messages.push({ role: 'user', content: message });

    const completion = await typhoon.chat.completions.create({
      model: 'typhoon-v2.1-12b-instruct',
      messages: messages,
      max_tokens: 150,
      temperature: 0.8,
    });

    const reply = completion.choices[0]?.message?.content || "‡∏≠‡∏∑‡∏≠... ‡∏á‡∏á ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏±‡πâ‡∏¢?";

    return NextResponse.json({ reply });

  } catch (error) {
    console.error("AI Error:", error);
    return NextResponse.json({ reply: "‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏∞... ‡∏°‡∏∂‡∏ô‡πÜ ‡∏≠‡∏¢‡∏π‡πà ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏±‡πâ‡∏¢? ü•∫" });
  }
}